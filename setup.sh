#!/bin/sh
# author: ayoub
# 42 Project: ft_services
# printf "\n\n\033[0;32m ███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████\033[0m\n"
# printf "\033[0;32m █░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█████████████████░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░░░███░░░░░░██░░░░░░█░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█\033[0m\n"
# printf "\033[0;32m █░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█████████████████░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█\033[0m\n"
# printf "\033[0;32m █░░▄▀░░░░░░░░░░█░░░░░░▄▀░░░░░░█████████████████░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░▄▀░░███░░▄▀░░██░░▄▀░░█░░░░▄▀░░░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░░░█\033[0m\n"
# printf "\033[0;32m █░░▄▀░░█████████████░░▄▀░░█████████████████████░░▄▀░░█████████░░▄▀░░█████████░░▄▀░░████░░▄▀░░███░░▄▀░░██░░▄▀░░███░░▄▀░░███░░▄▀░░█████████░░▄▀░░█████████░░▄▀░░█████████\033[0m\n"
# printf "\033[0;32m █░░▄▀░░░░░░░░░░█████░░▄▀░░█████████████████████░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░▄▀░░███░░▄▀░░██░░▄▀░░███░░▄▀░░███░░▄▀░░█████████░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░░░█\033[0m\n"
# printf "\033[0;32m █░░▄▀▄▀▄▀▄▀▄▀░░█████░░▄▀░░█████████████████████░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀░░██░░▄▀░░███░░▄▀░░███░░▄▀░░█████████░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█\033[0m\n"
# printf "\033[0;32m █░░▄▀░░░░░░░░░░█████░░▄▀░░█████████████████████░░░░░░░░░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░▄▀░░░░███░░▄▀░░██░░▄▀░░███░░▄▀░░███░░▄▀░░█████████░░▄▀░░░░░░░░░░█░░░░░░░░░░▄▀░░█\033[0m\n"
# printf "\033[0;32m █░░▄▀░░█████████████░░▄▀░░█████████████████████████████░░▄▀░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█████░░▄▀▄▀░░▄▀▄▀░░███░░▄▀░░███░░▄▀░░█████████░░▄▀░░█████████████████░░▄▀░░█\033[0m\n"
# printf "\033[0;32m █░░▄▀░░█████████████░░▄▀░░█████████████████████░░░░░░░░░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░██░░▄▀░░░░░░█░░░░▄▀▄▀▄▀░░░░█░░░░▄▀░░░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░░░█░░░░░░░░░░▄▀░░█\033[0m\n"
# printf "\033[0;32m █░░▄▀░░█████████████░░▄▀░░█████████████████████░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░██░░▄▀▄▀▄▀░░███░░░░▄▀░░░░███░░▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█\033[0m\n"
# printf "\033[0;32m █░░░░░░█████████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░██░░░░░░░░░░█████░░░░░░█████░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█\033[0m\n"
# printf "\033[0;32m ███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████\033[0m\n\n\n"

SSH_USERNAME="user"
SSH_PASSWORD="pass1234"
FTPS_USERNAME="user"
FTPS_PASSWORD="pass1234"
DB_USER="admin"
DB_PASSWORD="admin"

arr=(
    mysql
    phpmyadmin
    nginx
    wordpress
    ftps
    influxdb
    grafana
)

function install_kube(){
    dir_goinfre=/goinfre
    docker_dest=$dir_goinfre/.docker
    kube_dest=$dir_goinfre/.kube
    minikube_dest=$dir_goinfre/.minikube
    brew_home=$HOME/.brew
    brew_dest=$dir_goinfre/.brew

    pre_config_start=`date +%s`
    # Install Brew
    if ! $(which -s brew &> /dev/null); then
        echo "\033[0;31mBrew Not Installed, Installing...\033[0m"
        # Install brew
		rm -rf $HOME/.brew
        git clone --depth=1 https://github.com/Homebrew/brew $HOME/.brew
        echo 'export PATH=$HOME/.brew/bin:$PATH' >> $HOME/.zshrc
        source $HOME/.zshrc
        mv $brew_home $brew_dest
        ln -s $brew_dest
    else
        echo "\033[0;32mBrew Alredy Installed\033[0m"
        # mv $brew_home $brew_dest
        # ln -s $brew_dest
    fi
    echo "\033[0;32mUpdating Brew...\033[0m"
    brew update &> /dev/null
    # KUBECTL
    if ! $(which -s kubectl &> /dev/null); then
        echo "\033[0;31mKubectl not Installed, Installing...\033[0m"
        # Install kubectl
        brew install kubectl
        rm -rf $HOME/.kube
        rm -rf $kube_dest
        mkdir $kube_dest
        ln -s $kube_dest
    else
        echo "\033[0;32mKubectl Alredy Installed\033[0m"
    fi
    # MINIKUBE
    if ! $(which -s minikube &> /dev/null); then
        echo "\033[1;32mMinikube not Installed, Installing...\033[0m"
        # Install Minikube 
        brew install minikube
        rm -rf $HOME/.minikube
        rm -rf $minikube_dest
        mkdir $minikube_dest
        ln -s $minikube_dest
    else
        echo "\033[0;32mMinikube Alredy Installed\033[0m"
    fi
    # DOCKER
    if ! $(which -s docker &> /dev/null); then
      echo "\033[1;32mDocker not Installed, Installing...\033[0m"
      # Install Docker
      brew install docker
      rm -rf $HOME/.docker
      rm -rf $docker_dest
      mkdir $docker_dest
      ln -s $docker_dest
    else
        echo "\033[0;32mDocker Alredy Installed\033[0m"
    fi
    pre_config_end=`date +%s`	
	runtime=$((pre_config_end-pre_config_start))
	echo "\033[1;31mPre-config done - $runtime seconds)\033[0m"
}

function set_up() {
    minikube delete &> /dev/null
    echo "\033[0;32mCreating VirtualMachine\033[0m"
    if ! $(minikube start --vm-driver=virtualbox --disk-size=20g --memory=4g --cpus=4 &> /dev/null); then
        echo -e "\033[1;32mError Creating VirtualMachine\033[0m"
    fi
    if ! $(minikube status &> /dev/null); then
        sleep 10
        if ! $(minikube status &> /dev/null); then
            echo "\033[1;32mMinikube is not Running...\033[0m"
            exit 1
        fi
    else
        echo "\033[0;32mVirtualMachine was created successfully\033[0m"
    fi
    eval $(minikube docker-env)
    if [ $? -eq 0 ]; then
        echo -e "\033[1;32mENVIRMENT EXPORTED\033[0m"
    else
        echo -e "\033[0;32mERROR SETING ENVIREMENT\033[0m"
    fi

    # Install metallb
    kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.9.5/manifests/namespace.yaml
    kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.9.5/manifests/metallb.yaml
    # # On first install only
    kubectl create secret generic -n metallb-system memberlist --from-literal=secretkey="$(openssl rand -base64 128)"
    # # ConfigMap
    kubectl apply -f ./srcs/metallb-config.yaml
}


function ft_services() {
    MINIKUBE_IP=`minikube ip`
    FT_SERVICES_IP=`kubectl get svc | grep nginx | awk '{print $4}'`
    echo "\033[0;32m✅		ft_services deployment done (Hourra !)\033[0m"
    echo "\033[1;32m
    Minikube IP is : $MINIKUBE_IP
    ================================================================================
    LINKS:
        nginx:			https://$FT_SERVICES_IP (or http)
        wordpress:		http://$FT_SERVICES_IP:5050
        phpmyadmin:		http://$FT_SERVICES_IP:5000
        grafana:		http://$FT_SERVICES_IP:3000
    OTHERS:
        nginx:			ssh user@$FT_SERVICES_IP -p 22
        ftps:			USING FILEZILLA
        
    ACCOUNTS:			(username:password)
        ssh:			$SSH_USERNAME:$SSH_PASSWORD (port 22)
        ftps:			$FTPS_USERNAME:$FTPS_PASSWORD (port 21)
        database:		$DB_USER:$DB_PASSWORD (sql / phpmyadmin)
        grafana:		admin:admin
        wordpress:              admin:admin (Admin)
    TEST PERSISTENT MYSQL/INFLUXDB:
        kubectl exec -it \$(kubectl get pods | grep mysql | cut -d\" \" -f1) -- /bin/sh -c \"kill 1\"
        kubectl exec -it \$(kubectl get pods | grep influxdb | cut -d\" \" -f1) -- /bin/sh -c \"kill 1\"
    \033[0m"
}

function start_up(){
    if [[ $1 == "install" ]]; then
        install_kube
    elif [[ $1 == "setup" ]]; then
        set_up
    elif [[ $1 == "delete" ]]; then
        echo "\033[1;32m-------delete-------\033[0m"
        for k in "${arr[@]}"; do
            kubectl delete -f ./srcs/$k-deployment.yaml
        done
        echo "\033[1;32m------- All Services Deleted -------\033[0m"
    elif [[ $1 == "start" ]]; then
        start_time=`date +%s`
        echo "\033[0;32m-------Starting-------\033[0m"
        for i in "${arr[@]}"; do
            docker build -t $i ./srcs/$i
        done
        sleep 2
        # Create secret for mysql
        kubectl apply -f ./srcs/secret.yaml
        sleep 2
        # Create volumes
        kubectl apply -f ./srcs/PersistentVolume.yaml
        sleep 2
        for j in "${arr[@]}"; do
            kubectl apply -f ./srcs/$j-deployment.yaml
        done
        sleep 4
        end_time=`date +%s`
        runtime=$((end_time-start_time))
       echo "\033[1;31mPre-config done - $runtime seconds)\033[0m"
        minikube dashboard &> /dev/null
    elif [[ $1 == "show" ]]; then
        ft_services
    fi
}

start_up $1